name: Continuous Integration

env:
  RUST_LOG: info
  RUST_BACKTRACE: 1
  BAZEL_STARTUP_FLAGS: --bazelrc=${{ github.workspace }}/.github/github.bazelrc

on:
  pull_request:
    branches: [master]

jobs:
  test:
    name: Test
    strategy:
      matrix:
        # Create a job for each target triple
        include:
          - os: macos-11
            env:
              TARGET: "aarch64-apple-darwin"
          - os: ubuntu-20.04
            env:
              TARGET: "aarch64-unknown-linux-gnu"
          - os: macos-11
            env:
              TARGET: "x86_64-apple-darwin"
          - os: ubuntu-20.04
            env:
              TARGET: "x86_64-pc-windows-gnu"
          - os: windows-2019
            env:
              TARGET: "x86_64-pc-windows-msvc"
          - os: ubuntu-20.04
            env:
              TARGET: "x86_64-unknown-linux-gnu"
          - os: ubuntu-20.04
            env:
              TARGET: "x86_64-unknown-linux-musl"
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build
        runs: bazel build --bazelrc=.ci.bazelrc ...
      - name: Test
        runs: bazel test --bazelrc=.ci.bazelrc ...